---
title: "Deisotoper: Quantiles"
author: "Lucas Schmidt"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Quantiles}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---


## The quantile test data

The quantile test data contains 20 mass spectra which are from four different quantiles.

The Spectra used for the quantiles are:

1. Quantile: 21369, 22316, 15078, 22953 and 14987 (High Mascot score)
2. Quantile: 2270, 11881, 15609, 5702, 13056 (Mid to high Mascot score)
3. Quantile: 1737, 3681, 3971, 7988, 7988 (Mid Mascot score)
4. Quantile: 2496, 8951, 624, 2117, 18394 (Low to mid Mascot score (at least over 25))

```{r, echo=FALSE}
library(deisotoper)

QUANTILE <- load(system.file("extdata", name = 'FourQuantileTestDataDDA.RData', package = "deisotoper"))

QUANTILEMSM <- jCreateMSM(get(QUANTILE))

names <- c(21369, 22316, 15078, 22953, 14987, 2270, 11881, 15609, 5702, 13056, 1737, 3681, 3971, 7988, 7988, 2496, 8951, 624, 2117, 18394)
```

![](http://fgcz-ms.uzh.ch/~lucas/image_resources/quantiles.png){ width=100% }


## Differences between before and after deisotoping

Differences between non deisotoped and deisotoped spectra are marked in red.

```{r fig.width=8, fig.height=5, echo=FALSE}
loop <- function(start, stop) {
  for(i in start:stop) {
    index <- i + 1
    MS <- QUANTILEMSM$getMSlist()$get(as.integer(i))
    IMS <- jCreateIMS(MS)
    MSd <- jDeisotopeMS(MS)
    MSd2 <- jDeisotopeMS(MS, configfile = "/srv/lucas1/deisotoper/properties/StandartDecharge.properties")
    diff <- c(setdiff(MS$getMzArray(), MSd$getMzArray()), setdiff(MSd$getMzArray(), MS$getMzArray()))
    diff2 <- c(setdiff(MS$getMzArray(), MSd2$getMzArray()), setdiff(MSd2$getMzArray(), MS$getMzArray()))
    
    plot(x = MS$getMzArray(), y = MS$getIntensityArray(), type = "h", xlab = "mZ", ylab = "Intensity", main = paste("Spectra Number ", names[index], sep = ""))
    
    plot(x = MSd$getMzArray(), y = MSd$getIntensityArray(), type = "h", xlab = "mZ", ylab = "Intensity", main = paste("Spectra Number ", names[index], " deisotoped", sep = ""))
    abline(v=diff, col="#FF000033", lwd = 2)
    
    plot(x = MSd2$getMzArray(), y = MSd2$getIntensityArray(), type = "h", xlab = "mZ", ylab = "Intensity", main = paste("Spectra Number ", names[index], " deisotoped and decharged", sep = ""))
    abline(v=diff2, col="#FF000033", lwd = 2)
    
    
    delta <- c()
    for(i in 2:length(MS$getMzArray())) {
      m <- MS$getMzArray()[[i]] - MS$getMzArray()[[i - 1]]
      delta <- c(delta, round(m, digits = 5))
    }
    
    size2 <- IMS$getIsotopicMassSpectrum()$size() - 1
    if(IMS$getIsotopicMassSpectrum()$size() > 1) {
      for(j in 0:size2) {
        is <- deisotoper:::jGetIS(IMS, j)
        
        islist <- as.list(is$getIsotopicSet())
        
        peaks <- c()
        for(x in 1:length(islist)) {
          peaks <- c(peaks, islist[[x]])
        }
        
        min <- peaks[[1]]$getIsotopicCluster()$get(as.integer(0))$getMz() - 2
        max <- peaks[[length(peaks)]]$getIsotopicCluster()$get(as.integer(peaks[[length(peaks)]]$getIsotopicCluster()$size() - 1))$getMz() + 2
        
        plot(x = MS$getMzArray(), y = MS$getIntensityArray(), type = "h", axes = FALSE, xlab = "mZ", ylab = "Intensity", xlim = c(min, max), main = paste("Spectra Number ", names[index], ", Isotopic Set Number ", j+1, sep = ""))
        axis(side=1, at = MS$getMzArray())
        axis(side=2, at = seq(0, max(MS$getIntensityArray()) + 10000, by = 2000), labels = FALSE)
        axis(side=2, at = seq(0, max(MS$getIntensityArray()) + 10000, by = 8000), las = 1, tick = FALSE)
        
        for(x in 1:length(delta)) {
          if(x %% 2 == 0) {
            text(x = MS$getMzArray()[[x]] + delta[[x]] * 0.5 , y = 0.3 * max(MS$getIntensityArray(), na.rm=TRUE), labels = delta[[x]], cex = 0.8)
          } else {
            text(x = MS$getMzArray()[[x]] + delta[[x]] * 0.5 , y = 0.35 * max(MS$getIntensityArray(), na.rm=TRUE), labels = delta[[x]], cex = 0.8)
          }
        }
      }
    }
  }
}
```

### First quantile

```{r fig.width=8, fig.height=5, echo=FALSE}
loop(0, 4)
```


### Second quantile

```{r fig.width=8, fig.height=5, echo=FALSE}
loop(5, 9)
```


### Third quantile

```{r fig.width=8, fig.height=5, echo=FALSE}
loop(10, 14)
```


### Fourth quantile

```{r fig.retina=3, fig.width=8, fig.height=5, echo=FALSE}
loop(15, 19)
```